# Metafora Issue Tool — html2xml

**Назначение:** лёгкий браузерный мастер, который собирает XML-файл выпуска научного журнала
по внутренней схеме `journal3.xsd` (вариант «Метафоры») из HTML-страницы выпуска. Работает без базы данных,
всё хранит в PHP-сессии и позволяет _загрузить HTML → внести/распарсить метаданные → аннотировать статьи →
скачать XML_ и при желании валидировать его по XSD.

---

## Ключевые возможности

- **Загрузка HTML выпуска**: файл целиком кладётся в сессию и показывается справа в iframe-превью.
- **Кнопка «Спарсить»** возле каждого поля: переносит текущее выделение из превью в нужное поле.
- **Горячие клавиши** (см. `public/assets/selector.js`):
  - В превью (iframe): `Ctrl+Shift+C` — сохранить выделение (и скопировать его в буфер).
  - В форме: `Ctrl+Shift+V` — вставить сохранённое выделение в активное поле.
- **Структура выпуска**: журнал → выпуск (том/номер/год/дата) → список статей.
- **Аннотирование статей**: заголовки (RU/EN), аннотации (RU/EN), DOI/EDN, страницы, дата публикации,
  ключевые слова, **авторы** (массив с ФИО RU/EN, e-mail, ORCID, аффилиации и география RU/EN).
- **Список литературы**: вставляется «сырым» текстом (построчно); при генерации каждая строка
  попадает в `<references><reference><refInfo lang="ru"><text>…`.
- **Генерация XML** по `app/xsd/journal3.xsd`: формируется в `build_issue_xml()` (`app/bootstrap.php`).
- **Проверка по XSD (опционально)**: AJAX-валидация сформированного XML (см. «Валидация» ниже).
- **Автосохранение** формы статьи + индикатор состояния (зелёная точка «сохранено»).
- **Сброс сессии**: `public/reset.php` полностью очищает состояние.

---

## Требования

- **PHP** ≥ 8.0 (рекомендуется 8.1+)
- Расширения: **dom**, **libxml**, **mbstring**
- Доступ на запись не требуется (всё в сессии), но нужны **cookies** для работы сессии
- Ограничение по загрузке HTML определяется `upload_max_filesize`/`post_max_size` в `php.ini`

---

## Структура проекта

```
public/                # web root
  index.php            # основной мастер (шаги: welcome → upload → meta → articles → generate → validate → download)
  api.php              # AJAX-эндпоинты для автосохранения, авторов, чернового парсинга ссылок
  reset.php            # сброс сессии
  assets/              # стили и js (в т.ч. горячие клавиши копирования/вставки из iframe)
  schema/              # XSD для локальной валидации (см. ниже примечание о названиях)
app/
  bootstrap.php        # старт сессии, утилиты, структура данных, генератор XML
  xsd/journal3.xsd     # внутренняя XSD схемы, под которую собирается XML
```

---

## Установка / быстрый старт

1. **Разверните** файлы на сервере.
2. Сделайте **web root = `public/`**.  
   - Если изменить web root нельзя, используйте alias/virtual host к `public/`.
3. Убедитесь, что PHP умеет загружать файлы нужного размера (`upload_max_filesize`, `post_max_size`).
4. Откройте `/index.php` в браузере и следуйте шагам мастера.

> Проект без Composer/БД. Никакой миграции/сборки не требуется.

---

## Пользовательский поток

1. **Welcome** → кнопка «Начать новую сессию».  
2. **Upload** → загрузите **HTML выпуска** целиком. Справа появится предпросмотр.  
3. **Meta** → заполните метаданные журнала/выпуска. Можно выделять куски текста справа и нажимать **«Спарсить»**.  
4. **Articles** → задайте количество статей, затем у каждой:
   - заполните заголовки/аннотации RU/EN, DOI/EDN, страницы, дату;
   - добавьте авторов (кнопки `+/-` и перетасовка), заполните ФИО, контакты, аффилиации/города/страны RU/EN;
   - добавьте **References** (каждая ссылка — с новой строки).  
   Поля можно частично заполнять из выделений в предпросмотре. Работает **автосохранение**.
5. **Generate** → получите сформированный **XML** (просмотр).  
6. **Validate (опционально)** → проверка XML по локальной XSD (см. ниже).  
7. **Download** → скачайте XML-файл (имя строится из метаданных выпуска).

---

## Валидация XML по XSD

AJAX-валидация ищет схему по одному из путей (см. `public/index.php`, раздел `validate-xml`):

- `public/schema/metafora.xsd`
- `public/schema.xsd` (корень `public/`)
- `schema.xsd` (рядом с `public/`)

В комплекте есть **`public/schema/journal3.xsd`**, а генерация ведётся по **`app/xsd/journal3.xsd`**.  
Чтобы валидация «из коробки» работала без правки кода, **скопируйте или сделайте симлинк**:

```
public/schema/metafora.xsd  →  public/schema/journal3.xsd
```

или переименуйте `journal3.xsd` в `metafora.xsd`.

> Альтернатива: поправить массив `candidates` в `validate-xml` так, чтобы он включал `journal3.xsd`.

---

## API (через `public/api.php`)

Возвращает JSON. Основные действия:

- `GET a=ping` — проверка доступности.
- `POST a=setArticlesCount n=<int>` — установить число статей.
- `POST a=addAuthor n=<int>` — добавить автора в статью *n*.
- `POST a=removeAuthor n=<int> idx=<int>` — удалить автора с индексом *idx*.
- `POST a=reorderAuthors n=<int> order[]=2&order[]=0&order[]=1` — переставить авторов.
- `POST a=saveAuthors n=<int>` — сохранить массив авторов целиком (см. форму).
- `POST a=saveField n=<int> path=<field> value=<...>` — сохранить одно поле статьи (`title_ru`, `abstract_en`, `doi`, `pages`, `pub_date`, `references_raw` и др.).
- `POST a=saveAuthorField n=<int> idx=<int> field=<…> value=<…>` — сохранить одно поле автора.
- `POST a=extractRefsFromHtml css=<selector> n=<int>` — **черновой парсер списка литературы** из загруженного HTML выпуска по простому селектору (`.class`, `#id` или фрагмент тега). Результат пишется в `references_raw` статьи *n*.

> Парсер ссылок намеренно **очень упрощён** (регэкспы, замена `<br>`/`</p>` на переносы строк, снятие тегов). Для продакшн-скрейпинга рекомендуются DOM+XPath и нормализация пробелов/юникода/тире и т. п.

---

## Горячие клавиши

- В превью (iframe с HTML): **`Ctrl+Shift+C`** — сохранить текущее выделение и скопировать его в буфер обмена.
- В форме ввода: **`Ctrl+Shift+V`** — вставить сохранённый фрагмент в активное поле.

Визуальная подсказка реализована в `public/assets/selector.js`. Служебное хранилище — глобальный `window.__issueSelectedText`.

---

## Безопасность

- **Нет аутентификации/авторизации.** Деплойте за VPN/белым списком или ставьте фронтовой auth.
- **Нет CSRF‑защиты.** API рассчитан на доверенную среду/одного редактора.
- **Загруженный HTML не санитизируется**: отображается в iframe. Не подсовывайте непроверенный HTML
  из внешних источников — возможен XSS в пределах сессии редактора.
- **Сессии**: всё состояние в `$_SESSION`. Сброс — `public/reset.php`.

---

## Настройка PHP/сервера

- Увеличьте `upload_max_filesize` и `post_max_size` под размеры HTML.
- Включите `session.cookie_secure` (если HTTPS) и `session.cookie_httponly=1`.
- Для Apache: укажите DocumentRoot на `public/`. Для Nginx — `root`/`location` к `public/`.

Пример Nginx-фрагмента:

```
server {
  listen 443 ssl;
  server_name example.org;
  root /var/www/metafora-html2xml/public;

  index index.php;
  location / {
    try_files $uri /index.php?$query_string;
  }
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php-fpm:9000;
  }
}
```

---

## Известные ограничения и идеи на будущее

- Валидация ищет `metafora.xsd`/`schema.xsd`; в комплекте — `journal3.xsd` (см. раздел «Валидация»).
- References — построчно и только `lang="ru"`. Можно расширить поддержкой EN и структурным разбором.
- Нет предзаполнения из DOAJ/OJS; все поля вводятся вручную/копипастой из HTML.
- Нет экспорта нескольких выпусков в одном файле.
- Нет многостраничной автосохранённой истории/версий.

---

## Автор и лицензия

- Автор кода/проекта: **Растям Туктарович Алиев**  
- Лицензия по умолчанию: **AGPL-3.0-or-later** (см. файл `LICENSE`).

**Почему AGPL, а не GPLv3?**  
Это серверное веб‑приложение. Если кто-то запустит его как сервис «через сеть» и изменит код, **AGPL** обязывает
опубликовать исходники модификаций для пользователей сервиса. **GPLv3** такой «сетевой» обязанности не содержит.
Если вам не нужен сетевой копилефт — можете сменить лицензию на GPLv3 или MIT/Apache‑2.0 (пермишсив), но тогда
форки смогут держать приватные изменения как SaaS.

---

## Быстрый чек‑лист деплоя

- [ ] PHP 8.1+, ext-dom, ext-libxml, ext-mbstring
- [ ] web root = `public/`
- [ ] `upload_max_filesize`/`post_max_size` достаточно велики
- [ ] (опц.) `public/schema/metafora.xsd` указывает на реальную схему (см. «Валидация»)
- [ ] Доступ к панели ограничен (VPN/Basic Auth/IP Allowlist)

---

## Поддержка

Баги/улучшения — оформляйте как Issues в репозитории. Для отдельной доработки схемы или интеграции с OJS/DOAJ —
опишите требования, селекторы и ожидаемую структуру XML (или приложите XSD).
